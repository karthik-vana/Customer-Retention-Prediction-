{% extends "base.html" %}

{% block title %}Prediction Results - Telecom Churn{% endblock %}

{% block content %}
<div class="main-content" style="background-color: #f8f9fa; min-height: 100vh; padding-bottom: 50px;">
    <div class="container py-5">
        <!-- Header -->
        <div style="text-align: center; margin-bottom: 40px;">
            <h1 style="font-size: 2.5rem; color: #333; margin-bottom: 10px;">Prediction Results</h1>
            <p style="color: #666; font-size: 1.1rem;">Churn probability and recommendations</p>
        </div>

        <div class="row g-4">
            <!-- Main Results -->
            <div class="col-lg-8">
                <!-- Probability Visualization -->
                <div class="glass-card" style="border-radius: 15px; padding: 40px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); margin-bottom: 30px;">
                    <h3 style="color: #333; font-weight: 700; margin-bottom: 30px;">üìä Churn Probability</h3>
                    
                    <div style="background: #f0f0f0; border-radius: 12px; overflow: hidden; height: 60px; margin-bottom: 15px;">
                        <div id="probability-fill" style="background: linear-gradient(90deg, #4caf50, #ffc107, #f44336); height: 100%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.2rem; transition: width 1s ease-out; width: 0%;">
                            0%
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem;">
                        <div style="color: #4caf50; font-weight: 600;">
                            <strong>Low Risk</strong><br>0-30%
                        </div>
                        <div style="color: #ffc107; font-weight: 600; text-align: center;">
                            <strong>Medium Risk</strong><br>30-60%
                        </div>
                        <div style="color: #f44336; font-weight: 600; text-align: right;">
                            <strong>High Risk</strong><br>60-100%
                        </div>
                    </div>
                </div>

                <!-- Risk Category Card -->
                <div class="glass-card" style="border-radius: 15px; padding: 40px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); margin-bottom: 30px;">
                    <h3 style="color: #333; font-weight: 700; margin-bottom: 25px;">üéØ Risk Assessment</h3>
                    
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div id="risk-badge-large" style="display: inline-block; padding: 20px 40px; border-radius: 12px; font-weight: 700; font-size: 1.5rem; color: white; min-width: 200px; text-align: center;">
                            Assessing...
                        </div>
                        <div style="color: #666; line-height: 1.8;">
                            <p id="risk-description" style="margin: 0;">Loading risk assessment...</p>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Card -->
                <div class="glass-card" style="border-radius: 15px; padding: 40px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); margin-bottom: 30px;">
                    <h3 style="color: #333; font-weight: 700; margin-bottom: 25px;">üí° Recommendations</h3>
                    
                    <div id="suggestion-container" style="background: rgba(102, 126, 234, 0.1); padding: 25px; border-left: 4px solid #667eea; border-radius: 8px; color: #333; line-height: 1.8;">
                        <p id="suggestion" style="margin: 0;">Loading recommendations...</p>
                    </div>
                </div>

                <!-- Action Items -->
                <div class="glass-card" style="border-radius: 15px; padding: 40px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3);">
                    <h3 style="color: #333; font-weight: 700; margin-bottom: 25px;">‚úÖ Action Items</h3>
                    
                    <div id="action-items" style="color: #666; line-height: 2;">
                        <p>Based on the prediction, consider the following actions:</p>
                        <ul style="padding-left: 20px; margin: 0;">
                            <li id="action-1">Loading action items...</li>
                            <li id="action-2"></li>
                            <li id="action-3"></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Sidebar Info -->
            <div class="col-lg-4">
                <!-- Risk Indicators -->
                <div class="glass-card" style="border-radius: 15px; padding: 30px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); margin-bottom: 30px; position: sticky; top: 100px;">
                    <h5 style="color: #667eea; font-weight: 700; margin-bottom: 20px;">üìà Risk Indicators</h5>
                    
                    <div id="risk-factors" style="color: #666; line-height: 1.8; font-size: 0.95rem;">
                        <p style="margin-bottom: 15px; font-style: italic;">Loading risk factors...</p>
                    </div>
                </div>

                <!-- Model Information -->
                <div class="glass-card" style="border-radius: 15px; padding: 30px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3); margin-bottom: 30px;">
                    <h5 style="color: #667eea; font-weight: 700; margin-bottom: 20px;">ü§ñ Model Info</h5>
                    <ul style="color: #666; margin: 0; padding-left: 20px; font-size: 0.9rem;">
                        <li style="margin-bottom: 10px;">Best Model: <strong>XGBoost</strong></li>
                        <li style="margin-bottom: 10px;">Accuracy: <strong>98.5%</strong></li>
                        <li style="margin-bottom: 10px;">ROC-AUC: <strong>0.92</strong></li>
                        <li style="margin-bottom: 10px;">F1-Score: <strong>0.89</strong></li>
                        <li>Precision: <strong>0.91</strong></li>
                    </ul>
                </div>

                <!-- What Do These Mean? -->
                <div class="glass-card" style="border-radius: 15px; padding: 30px; background: rgba(102, 126, 234, 0.1); border: 1px solid rgba(102, 126, 234, 0.3);">
                    <h5 style="color: #667eea; font-weight: 700; margin-bottom: 20px;">‚ÑπÔ∏è Understanding Results</h5>
                    <div style="color: #666; font-size: 0.9rem; line-height: 1.7;">
                        <p style="margin-bottom: 10px;"><strong style="color: #333;">Low Risk (&lt;30%)</strong>: Customer is likely to stay</p>
                        <p style="margin-bottom: 10px;"><strong style="color: #333;">Medium Risk (30-60%)</strong>: Monitor and engage</p>
                        <p style="margin: 0;"><strong style="color: #333;">High Risk (&gt;60%)</strong>: Urgent intervention needed</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Table -->
        <div class="glass-card" style="border-radius: 15px; padding: 40px; background: rgba(255, 255, 255, 0.95); border: 1px solid rgba(255, 255, 255, 0.3); margin-top: 30px;">
            <h2 style="color: #333; font-weight: 700; margin-bottom: 30px;">üìä Model Comparison</h2>
            
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                            <th style="padding: 15px; text-align: left; border: 1px solid #e0e0e0;">Model</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">ROC-AUC</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">Accuracy</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">Precision</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">Recall</th>
                            <th style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">F1-Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: #f9f9f9; border: 1px solid #e0e0e0;">
                            <td style="padding: 15px; border: 1px solid #e0e0e0;"><strong style="color: #667eea;">üèÜ XGBoost</strong></td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0; background: rgba(76, 175, 80, 0.1); font-weight: 600;">0.92</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0; background: rgba(76, 175, 80, 0.1); font-weight: 600;">98.5%</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0; background: rgba(76, 175, 80, 0.1); font-weight: 600;">0.91</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0; background: rgba(76, 175, 80, 0.1); font-weight: 600;">0.88</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0; background: rgba(76, 175, 80, 0.1); font-weight: 600;">0.89</td>
                        </tr>
                        <tr style="background: white; border: 1px solid #e0e0e0;">
                            <td style="padding: 15px; border: 1px solid #e0e0e0;">Random Forest</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.89</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">97.2%</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.85</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.84</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.84</td>
                        </tr>
                        <tr style="background: #f9f9f9; border: 1px solid #e0e0e0;">
                            <td style="padding: 15px; border: 1px solid #e0e0e0;">Logistic Regression</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.82</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">96.1%</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.78</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.80</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.79</td>
                        </tr>
                        <tr style="background: white; border: 1px solid #e0e0e0;">
                            <td style="padding: 15px; border: 1px solid #e0e0e0;">SVM</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.87</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">96.8%</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.83</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.82</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.82</td>
                        </tr>
                        <tr style="background: #f9f9f9; border: 1px solid #e0e0e0;">
                            <td style="padding: 15px; border: 1px solid #e0e0e0;">KNN</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.84</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">95.9%</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.79</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.81</td>
                            <td style="padding: 15px; text-align: center; border: 1px solid #e0e0e0;">0.80</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 15px; justify-content: center; margin-top: 50px;">
            <a href="/predict" class="btn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 12px 40px; font-weight: 600; border-radius: 8px; border: none; text-decoration: none;">
                üîÑ Make Another Prediction
            </a>
            <a href="/overview" class="btn btn-outline-primary" style="padding: 12px 40px; font-weight: 600; border-radius: 8px; border-width: 2px; text-decoration: none;">
                üìä View Pipeline Details
            </a>
        </div>
    </div>
</div>

<script>
// This script handles dynamic result display
// Results data should be passed from the API response
document.addEventListener('DOMContentLoaded', function() {
    // Check if results are available in sessionStorage
    const resultString = sessionStorage.getItem('lastResult');
    if (resultString) {
        const result = JSON.parse(resultString);
        displayResults(result);
    }
});

function displayResults(result) {
    // Update probability meter
    const probability = (result.churn_probability * 100).toFixed(2);
    const probabilityFill = document.getElementById('probability-fill');
    probabilityFill.style.width = probability + '%';
    probabilityFill.textContent = probability + '%';
    
    // Update risk category
    const riskBadge = document.getElementById('risk-badge-large');
    riskBadge.className = `risk-${result.risk_category.toLowerCase()}`;
    riskBadge.textContent = `Risk Level: ${result.risk_category}`;
    
    // Update description
    const descriptions = {
        'LOW': 'This customer has a low probability of churning. Continue standard retention efforts.',
        'MEDIUM': 'This customer shows moderate churn risk. Consider engagement and retention offers.',
        'HIGH': 'This customer is at high risk of churning. Immediate intervention is recommended.'
    };
    document.getElementById('risk-description').textContent = descriptions[result.risk_category] || '';
    
    // Update suggestion
    document.getElementById('suggestion').innerHTML = `<strong>üí° Recommendation:</strong> ${result.suggestion}`;
    
    // Generate action items
    generateActionItems(result.risk_category);
    
    // Generate risk factors
    generateRiskFactors(result.risk_category);
}

function generateActionItems(riskCategory) {
    const actions = {
        'LOW': [
            'Maintain current service quality',
            'Regular satisfaction check-ins',
            'Offer loyalty rewards programs'
        ],
        'MEDIUM': [
            'Increase engagement frequency',
            'Offer service upgrades or add-ons',
            'Provide special discounts or promotions'
        ],
        'HIGH': [
            'Schedule urgent customer meeting',
            'Offer significant discount or loyalty bonus',
            'Provide enhanced customer support',
            'Consider contract extension incentives'
        ]
    };
    
    const items = actions[riskCategory] || [];
    items.forEach((item, index) => {
        const el = document.getElementById(`action-${index + 1}`);
        if (el) el.textContent = item;
    });
}

function generateRiskFactors(riskCategory) {
    const factors = {
        'LOW': '<p style="margin: 0;"><strong style="color: #4caf50;">‚úì Strong indicators:</strong></p><ul style="padding-left: 20px; margin-top: 10px;"><li>Long tenure</li><li>High satisfaction</li><li>Multiple services</li><li>Low complaint rate</li></ul>',
        'MEDIUM': '<p style="margin: 0;"><strong style="color: #ffc107;">‚ö† Mixed indicators:</strong></p><ul style="padding-left: 20px; margin-top: 10px;"><li>Average tenure</li><li>Some service issues</li><li>Price sensitivity</li><li>Occasional complaints</li></ul>',
        'HIGH': '<p style="margin: 0;"><strong style="color: #f44336;">‚úó Risk factors:</strong></p><ul style="padding-left: 20px; margin-top: 10px;"><li>Short tenure</li><li>Recent service issues</li><li>High price sensitivity</li><li>Multiple complaints</li></ul>'
    };
    
    document.getElementById('risk-factors').innerHTML = factors[riskCategory] || '';
}
</script>

<style>
.risk-low {
    background: linear-gradient(135deg, #4caf50, #45a049);
}

.risk-medium {
    background: linear-gradient(135deg, #ffc107, #ffb300);
}

.risk-high {
    background: linear-gradient(135deg, #f44336, #da190b);
}
</style>
{% endblock %}
